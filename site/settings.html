<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Settings</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, Cantarell, sans-serif;
        background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
        min-height: 100vh;
        color: white;
      }

      .header {
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(10px);
        padding: 20px 40px;
        border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      @media (max-width: 768px) {
        .header {
          padding: 15px 20px;
        }

        .header h1 {
          font-size: 1.5em;
        }
      }

      .header h1 {
        font-size: 2em;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .back-btn {
        background: rgba(102, 126, 234, 0.2);
        border: 2px solid rgba(102, 126, 234, 0.4);
        color: white;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1em;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-block;
      }

      .back-btn:hover {
        background: rgba(102, 126, 234, 0.4);
        border-color: rgba(102, 126, 234, 0.6);
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 40px;
      }

      @media (max-width: 768px) {
        .container {
          padding: 20px;
          max-width: 100%;
        }
      }

      .section {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 12px;
        padding: 30px;
        margin-bottom: 30px;
        border: 2px solid rgba(255, 255, 255, 0.1);
      }

      .section h2 {
        font-size: 1.8em;
        margin-bottom: 20px;
        color: #667eea;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        color: rgba(255, 255, 255, 0.9);
        font-weight: 500;
      }

      .form-group input[type="text"],
      .form-group input[type="password"],
      .form-group select {
        width: 100%;
        padding: 12px;
        background: rgba(255, 255, 255, 0.1);
        border: 2px solid rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        color: white;
        font-size: 1em;
      }

      .form-group input[type="checkbox"] {
        width: 20px;
        height: 20px;
        margin-right: 10px;
      }

      .checkbox-label {
        display: flex;
        align-items: center;
        cursor: pointer;
      }

      .btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1em;
        transition: transform 0.3s ease;
        margin-right: 10px;
      }

      .btn:hover {
        transform: translateY(-2px);
      }

      .btn-secondary {
        background: rgba(255, 255, 255, 0.1);
        border: 2px solid rgba(255, 255, 255, 0.2);
      }

      .movie-list {
        max-height: 500px;
        overflow-y: auto;
      }

      .movie-item {
        background: rgba(255, 255, 255, 0.05);
        padding: 15px;
        margin-bottom: 10px;
        border-radius: 8px;
        display: grid;
        grid-template-columns: 60px 1fr auto;
        align-items: center;
        gap: 15px;
        width: 100%;
      }

      .movie-item .movie-actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      @media (max-width: 768px) {
        .movie-item {
          grid-template-columns: 50px 1fr;
          gap: 10px;
          padding: 12px;
        }

        .movie-item img {
          width: 50px;
          height: 75px;
        }

        .movie-item .movie-actions {
          grid-column: 1 / -1;
          justify-content: flex-start;
          gap: 8px;
          margin-top: 8px;
        }

        .movie-name {
          font-size: 0.95em;
        }
      }

      @media (max-width: 480px) {
        .movie-item .movie-actions .btn {
          flex: 1;
          min-width: 80px;
        }
      }

      .movie-item img {
        width: 60px;
        height: 90px;
        object-fit: cover;
        border-radius: 4px;
      }

      .movie-info {
        flex: 1;
        min-width: 0;
        margin-left: 20px;
      }

      .movie-name {
        font-weight: 600;
        margin-bottom: 5px;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .movie-actions {
        display: contents;
      }

      .small-btn {
        padding: 8px 16px;
        font-size: 0.9em;
      }

      .message {
        padding: 12px;
        border-radius: 8px;
        margin-top: 15px;
        display: none;
      }

      .message.success {
        background: rgba(76, 175, 80, 0.2);
        border: 2px solid rgba(76, 175, 80, 0.4);
        color: #4caf50;
      }

      .message.error {
        background: rgba(244, 67, 54, 0.2);
        border: 2px solid rgba(244, 67, 54, 0.4);
        color: #f44336;
      }

      .file-upload {
        display: none;
      }

      .upload-label {
        display: inline-block;
        padding: 8px 16px;
        background: rgba(102, 126, 234, 0.2);
        border: 2px solid rgba(102, 126, 234, 0.4);
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.9em;
        transition: all 0.3s ease;
      }

      .upload-label:hover {
        background: rgba(102, 126, 234, 0.4);
      }

      /* Edit Menu Popup */
      .edit-menu-popup {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(30, 30, 50, 0.98);
        border: 2px solid rgba(102, 126, 234, 0.6);
        border-radius: 12px;
        padding: 30px;
        z-index: 1000;
        min-width: 400px;
        max-width: 90vw;
        max-height: 85vh;
        overflow-y: auto;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
      }

      @media (max-width: 768px) {
        .edit-menu-popup {
          min-width: unset;
          width: 90vw;
          padding: 20px;
        }

        .popup-header {
          font-size: 1.3em;
        }
      }

      .edit-menu-popup.active {
        display: block;
      }

      .popup-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        z-index: 999;
      }

      .popup-overlay.active {
        display: block;
      }

      .popup-header {
        font-size: 1.5em;
        font-weight: 600;
        margin-bottom: 20px;
        color: #667eea;
      }

      .popup-option {
        background: rgba(255, 255, 255, 0.05);
        padding: 15px;
        margin-bottom: 10px;
        border-radius: 8px;
        cursor: pointer;
        border: 2px solid rgba(255, 255, 255, 0.1);
        transition: all 0.3s ease;
      }

      .popup-option:hover {
        background: rgba(102, 126, 234, 0.2);
        border-color: rgba(102, 126, 234, 0.4);
      }

      .popup-option-title {
        font-weight: 600;
        margin-bottom: 5px;
      }

      .popup-option-desc {
        color: rgba(255, 255, 255, 0.6);
        font-size: 0.9em;
      }

      .popup-close {
        background: rgba(255, 255, 255, 0.1);
        border: 2px solid rgba(255, 255, 255, 0.2);
        color: white;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        width: 100%;
        margin-top: 15px;
        font-size: 1em;
      }

      .popup-close:hover {
        background: rgba(255, 255, 255, 0.15);
      }

      .btn-delete {
        background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
      }

      .btn-delete:hover {
        opacity: 0.9;
      }

      .folder-select-container {
        margin-top: 15px;
      }

      .folder-select-container select {
        width: 100%;
        padding: 12px;
        background: rgba(255, 255, 255, 0.1);
        border: 2px solid rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        color: white;
        font-size: 1em;
        margin-bottom: 10px;
      }

      .folder-select-container input {
        width: 100%;
        padding: 12px;
        background: rgba(255, 255, 255, 0.1);
        border: 2px solid rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        color: white;
        font-size: 1em;
      }

      /* Tab Styles */
      .tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 30px;
        border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        overflow-x: auto;
      }

      .tab {
        background: transparent;
        border: none;
        color: rgba(255, 255, 255, 0.6);
        padding: 15px 25px;
        cursor: pointer;
        font-size: 1.1em;
        border-bottom: 3px solid transparent;
        transition: all 0.3s ease;
      }

      .tab:hover {
        color: rgba(255, 255, 255, 0.9);
      }

      .tab.active {
        color: #667eea;
        border-bottom-color: #667eea;
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }

      .roku-device {
        background: rgba(255, 255, 255, 0.05);
        padding: 15px;
        margin-bottom: 15px;
        border-radius: 12px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border: 2px solid rgba(102, 126, 234, 0.2);
        transition: all 0.3s ease;
      }

      .roku-device:hover {
        border-color: rgba(102, 126, 234, 0.4);
        background: rgba(255, 255, 255, 0.08);
      }

      .roku-device-info {
        flex: 1;
      }

      .roku-device-name {
        font-weight: 600;
        margin-bottom: 5px;
        font-size: 1.2em;
      }

      .roku-device-ip {
        color: rgba(255, 255, 255, 0.6);
        font-size: 0.9em;
      }

      .instructions {
        background: rgba(102, 126, 234, 0.1);
        border-left: 4px solid #667eea;
        padding: 20px;
        margin-bottom: 20px;
        border-radius: 4px;
      }

      .instructions h3 {
        margin-bottom: 15px;
        color: #667eea;
      }

      .instructions ol {
        margin-left: 20px;
      }

      .instructions li {
        margin-bottom: 10px;
        line-height: 1.6;
      }

      .instructions code {
        background: rgba(0, 0, 0, 0.3);
        padding: 2px 6px;
        border-radius: 3px;
        font-family: monospace;
      }

      .spinner {
        border: 3px solid rgba(255, 255, 255, 0.1);
        border-top: 3px solid #667eea;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        animation: spin 1s linear infinite;
        display: inline-block;
        margin-right: 10px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .notification-item {
        background: rgba(255, 255, 255, 0.05);
        padding: 15px;
        margin-bottom: 10px;
        border-radius: 8px;
        border-left: 4px solid;
        display: flex;
        gap: 15px;
        align-items: flex-start;
      }

      .notification-item.success {
        border-left-color: #4caf50;
      }

      .notification-item.info {
        border-left-color: #2196f3;
      }

      .notification-item.warning {
        border-left-color: #ff9800;
      }

      .notification-item.error {
        border-left-color: #f44336;
      }

      .notification-icon {
        font-size: 24px;
        min-width: 30px;
        text-align: center;
      }

      .notification-content {
        flex: 1;
      }

      .notification-title {
        font-weight: 600;
        margin-bottom: 5px;
        font-size: 1.1em;
      }

      .notification-message {
        color: rgba(255, 255, 255, 0.8);
        line-height: 1.5;
      }

      .notification-time {
        color: rgba(255, 255, 255, 0.5);
        font-size: 0.85em;
        margin-top: 5px;
      }

      #titlesToRip {
        font-size: 20px;
        padding: 5px;
      }
      .two-columns {
        display: grid;
        grid-template-columns: 50% 50%;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>‚öôÔ∏è Settings</h1>
      <a href="/" class="back-btn">‚Üê Back to Movies</a>
    </div>

    <div class="container">
      <!-- Tabs -->
      <div class="tabs">
        <button class="tab active" onclick="switchTab('general')">
          General
        </button>
        <button class="tab" onclick="switchTab('movies')">Movies</button>
        <button class="tab" onclick="switchTab('ripper')">Disc Ripper</button>
        <button class="tab" onclick="switchTab('notifications')">
          Notifications
        </button>
        <button class="tab" onclick="switchTab('roku')">Roku</button>
      </div>

      <!-- General Settings Tab -->
      <div id="general-tab" class="tab-content active">
        <div class="section">
          <h2>General Settings</h2>
          <div class="form-group">
            <label for="serviceName">Service Name</label>
            <input
              type="text"
              id="serviceName"
              placeholder="e.g., MatthiasTV"
            />
            <small
              style="
                color: rgba(255, 255, 255, 0.6);
                display: block;
                margin-top: 5px;
              "
              >Friendly name for your streaming service</small
            >
          </div>
          <div class="form-group">
            <label for="url">Server URL</label>
            <div style="display: flex; gap: 10px; align-items: flex-start">
              <input
                type="text"
                id="url"
                placeholder="e.g., https://media.msouthwick.com"
                style="flex: 1"
              />
              <button
                class="btn"
                onclick="detectIPAddress()"
                style="white-space: nowrap"
              >
                Detect IP
              </button>
            </div>
            <small
              style="
                color: rgba(255, 255, 255, 0.6);
                display: block;
                margin-top: 5px;
              "
              >Full URL where the server is accessible (with http:// or
              https://)</small
            >
          </div>
          <div class="form-group">
            <label for="password">Password</label>
            <input
              type="password"
              id="password"
              placeholder="Password for accessing the server"
            />
          </div>
          <div class="form-group">
            <label class="checkbox-label">
              <input type="checkbox" id="passwordRequired" />
              <span>Require password to access server</span>
            </label>
          </div>
          <div class="two-columns">
            <button class="btn" onclick="saveGeneralSettings()">
              Save Settings
            </button>
            <button
              class="btn btn-secondary"
              onclick="updateSoftware()"
              style="margin-left: 10px"
            >
              Update Software
            </button>
          </div>

          <div class="message" id="generalMessage"></div>
          <div class="message" id="updateMessage"></div>
          <div
            style="
              margin-top: 30px;
              padding-top: 20px;
              border-top: 1px solid rgba(255, 255, 255, 0.1);
              text-align: center;
              color: rgba(255, 255, 255, 0.5);
              font-size: 0.9em;
            "
          >
            <div id="versionInfo">Loading version...</div>
          </div>
        </div>
      </div>

      <!-- Movies Tab -->
      <div id="movies-tab" class="tab-content">
        <div class="section">
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 20px;
            "
          >
            <h2 style="margin: 0">Manage Movies</h2>
            <div
              id="movieCount"
              style="color: rgba(255, 255, 255, 0.7); font-size: 1em"
            >
              Loading...
            </div>
          </div>
          <div class="movie-list" id="movieList">
            <p style="text-align: center; color: rgba(255, 255, 255, 0.5)">
              Loading movies...
            </p>
          </div>
        </div>
      </div>

      <!-- Disc Ripper Tab -->
      <div id="ripper-tab" class="tab-content">
        <div class="section">
          <h2>Disc Ripper Settings</h2>

          <div class="form-group">
            <label for="outputSubfolder">Output Folder (optional)</label>
            <input
              type="text"
              id="outputSubfolder"
              placeholder="e.g., The Office Season 1"
            />
            <small
              style="
                color: rgba(255, 255, 255, 0.6);
                display: block;
                margin-top: 5px;
              "
            >
              Leave empty for movies, or enter a folder name for TV shows/series
              (e.g., "Breaking Bad Season 1")
            </small>
          </div>

          <div class="form-group">
            <label for="titlesToRip">Number of Titles to Rip</label>
            <input
              type="number"
              id="titlesToRip"
              min="1"
              max="10"
              placeholder="1"
            />
            <small
              style="
                color: rgba(255, 255, 255, 0.6);
                display: block;
                margin-top: 5px;
              "
            >
              How many titles to rip from each disc (sorted by length, longest
              first). Most movies have 1 main title.
            </small>
          </div>

          <div class="form-group">
            <label class="checkbox-label">
              <input type="checkbox" id="autoDetectEpisodes" />
              <span>Auto-detect TV episodes</span>
            </label>
            <small
              style="
                display: block;
                color: rgba(255, 255, 255, 0.5);
                margin-top: 5px;
              "
            >
              Automatically rip all episodes on a disc (up to 12) by analyzing
              title durations. Completely ignores "Titles to Rip" when enabled.
              Perfect for TV series!
            </small>
          </div>

          <div class="form-group">
            <label for="minTitleLength">Minimum Title Length (seconds)</label>
            <input
              disabled
              type="number"
              id="minTitleLength"
              min="60"
              max="7200"
              placeholder="300"
            />
            <small
              style="
                color: rgba(255, 255, 255, 0.6);
                display: block;
                margin-top: 5px;
              "
            >
              Ignore titles shorter than this (300 seconds = 5 minutes). Helps
              skip previews and extras.
            </small>
          </div>

          <div class="form-group">
            <label class="checkbox-label">
              <input disabled type="checkbox" id="autoEject" />
              <span>Auto-eject disc after ripping</span>
            </label>
          </div>

          <div class="form-group">
            <label class="checkbox-label">
              <input disabled type="checkbox" id="notifyOnComplete" />
              <span>Show notification when ripping completes</span>
            </label>
          </div>

          <div class="form-group">
            <label class="checkbox-label">
              <input disabled type="checkbox" id="keepMKV" />
              <span>Keep MKV files (in addition to MP4)</span>
            </label>
          </div>

          <button class="btn" onclick="saveRipperSettings()">
            Save Ripper Settings
          </button>
          <div class="message" id="ripperMessage"></div>
        </div>
      </div>

      <!-- Notifications Tab -->
      <div id="notifications-tab" class="tab-content">
        <div class="section">
          <h2>Disc Ripper Activity</h2>

          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 20px;
            "
          >
            <p style="color: rgba(255, 255, 255, 0.7)">
              Real-time notifications from the disc ripper service
            </p>
            <div style="display: flex; gap: 10px">
              <button
                class="btn btn-secondary small-btn"
                onclick="loadNotifications()"
              >
                üîÑ Refresh
              </button>
              <button
                class="btn btn-secondary small-btn"
                onclick="clearNotifications()"
              >
                Clear History
              </button>
            </div>
          </div>

          <div
            id="notificationsList"
            style="max-height: 600px; overflow-y: auto"
          >
            <p
              style="
                text-align: center;
                color: rgba(255, 255, 255, 0.5);
                padding: 40px;
              "
            >
              Loading notifications...
            </p>
          </div>
        </div>
      </div>

      <!-- Roku Tab -->
      <div id="roku-tab" class="tab-content">
        <div class="section">
          <h2>Roku App Setup</h2>

          <div class="instructions">
            <h3>Step 1: Enable Developer Mode on Your Roku</h3>
            <ol>
              <li>
                On your Roku remote, press this sequence quickly:
                <code>Home</code> (3√ó), <code>Up</code> (2√ó),
                <code>Right</code>, <code>Left</code>, <code>Right</code>,
                <code>Left</code>, <code>Right</code>
              </li>
              <li>The Developer Settings screen will appear</li>
              <li>Enable "Developer Mode"</li>
              <li>
                Set a password when prompted and
                <strong>remember this password</strong>
              </li>
              <li>Your Roku will reboot</li>
            </ol>
          </div>

          <div class="instructions">
            <h3>Step 2: Find Your Roku Device</h3>
            <p style="margin-bottom: 15px">
              Click the button below to automatically find Roku devices on your
              network.
            </p>
          </div>

          <div class="form-group">
            <button class="btn" onclick="scanForRokuDevices()">
              <span id="scanButtonText">üîç Find My Roku</span>
            </button>
          </div>

          <div id="rokuDeviceList"></div>

          <div class="message" id="rokuMessage"></div>
        </div>
      </div>
    </div>

    <!-- Edit Menu Popup -->
    <div
      class="popup-overlay"
      id="popupOverlay"
      onclick="closeEditMenu()"
    ></div>
    <div class="edit-menu-popup" id="editMenuPopup">
      <div class="popup-header">Edit Movie</div>
      <div id="editMenuContent"></div>
    </div>

    <script>
      let movies = [];
      let currentEditingMovie = null;
      let availableFolders = [];

      // Tab switching
      function switchTab(tabName) {
        // Stop notification refresh if leaving notifications tab
        stopNotificationRefresh();

        // Hide all tabs
        document.querySelectorAll(".tab-content").forEach((tab) => {
          tab.classList.remove("active");
        });
        document.querySelectorAll(".tab").forEach((tab) => {
          tab.classList.remove("active");
        });

        // Show selected tab
        document.getElementById(tabName + "-tab").classList.add("active");
        event.target.classList.add("active");

        // Start notification refresh if entering notifications tab
        if (tabName === "notifications") {
          startNotificationRefresh();
        }
      }

      // Scan for Roku devices
      async function scanForRokuDevices() {
        const button = document.getElementById("scanButtonText");
        const originalText = button.textContent;
        button.innerHTML = '<span class="spinner"></span>Scanning network...';

        try {
          const response = await fetch("/api/roku/scan", {
            credentials: "include",
          });

          if (response.status === 401) {
            window.location.href =
              "/login?next=" + encodeURIComponent("/settings.html");
            return;
          }

          const devices = await response.json();
          displayRokuDevices(devices);

          if (devices.length === 0) {
            showMessage(
              "rokuMessage",
              "No Roku devices found on the network. Make sure your Roku is on the same network and Developer Mode is enabled.",
              "error"
            );
          } else {
            showMessage(
              "rokuMessage",
              `Found ${devices.length} Roku device(s)!`,
              "success"
            );
          }
        } catch (error) {
          showMessage(
            "rokuMessage",
            "Error scanning for devices: " + error.message,
            "error"
          );
        } finally {
          button.textContent = originalText;
        }
      }

      function displayRokuDevices(devices) {
        const container = document.getElementById("rokuDeviceList");

        if (devices.length === 0) {
          container.innerHTML = "";
          return;
        }

        container.innerHTML = `
                <div style="margin-top: 30px;">
                    <h3 style="color: #667eea; margin-bottom: 20px;">Step 3: Deploy to Your Roku</h3>
                    ${devices
                      .map(
                        (device, index) => `
                        <div class="roku-device" style="flex-direction: column; align-items: stretch; padding: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <div class="roku-device-info">
                                    <div class="roku-device-name">üì∫ ${
                                      device.name ||
                                      "Roku Device " + (index + 1)
                                    }</div>
                                </div>
                            </div>
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label for="password-${index}">Developer Password</label>
                                <input type="password" id="password-${index}" placeholder="Enter the password you set in Developer Mode" style="width: 100%; padding: 12px; background: rgba(255, 255, 255, 0.1); border: 2px solid rgba(255, 255, 255, 0.2); border-radius: 8px; color: white; font-size: 1em;">
                            </div>
                            <button class="btn" onclick="deployToRokuDevice('${
                              device.ip
                            }', ${index})" style="width: 100%;">
                                <span id="deploy-btn-${index}">üì≤ Deploy to This Roku</span>
                            </button>
                            <div class="message" id="deploy-message-${index}" style="margin-top: 10px;"></div>
                        </div>
                    `
                      )
                      .join("")}
                </div>
            `;
      }

      // Deploy to specific Roku device
      async function deployToRokuDevice(ip, index) {
        const password = document.getElementById(`password-${index}`).value;

        if (!password) {
          showMessage(
            `deploy-message-${index}`,
            "Please enter your developer password",
            "error"
          );
          return;
        }

        const button = document.getElementById(`deploy-btn-${index}`);
        const originalText = button.textContent;
        button.innerHTML =
          '<span class="spinner"></span>Building and deploying...';

        try {
          const response = await fetch("/api/roku/deploy", {
            method: "POST",
            credentials: "include",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              ip,
              username: "rokudev",
              password,
            }),
          });

          if (response.status === 401) {
            window.location.href =
              "/login?next=" + encodeURIComponent("/settings.html");
            return;
          }

          const result = await response.json();
          if (result.success) {
            showMessage(
              `deploy-message-${index}`,
              "‚úÖ App successfully deployed! Check your Roku.",
              "success"
            );
            // Clear password field after success
            document.getElementById(`password-${index}`).value = "";
          } else {
            showMessage(
              `deploy-message-${index}`,
              "Error: " + result.error,
              "error"
            );
          }
        } catch (error) {
          showMessage(
            `deploy-message-${index}`,
            "Error deploying: " + error.message,
            "error"
          );
        } finally {
          button.innerHTML = originalText;
        }
      }

      // Helper function to escape HTML
      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      // Check authentication and redirect if needed
      async function checkAuth() {
        try {
          const response = await fetch("/api/settings", {
            credentials: "include",
          });
          if (response.status === 401) {
            // Not authenticated, redirect to login
            // window.location.href = '/login.html?next=' + encodeURIComponent('/settings.html');
            return false;
          }
          return true;
        } catch (error) {
          console.error("Auth check failed:", error);
          return false;
        }
      }

      // Load movies on page load
      async function loadMovies() {
        try {
          const response = await fetch("/api/movies-list", {
            credentials: "include",
          });
          if (response.status === 401) {
            // window.location.href = '/login?next=' + encodeURIComponent('/settings.html');
            return;
          }
          movies = await response.json();
          renderMovies();
        } catch (error) {
          console.error("Error loading movies:", error);
          document.getElementById("movieList").innerHTML =
            '<p style="text-align: center; color: #f44336;">Error loading movies</p>';
        }
      }

      function renderMovies() {
        const movieList = document.getElementById("movieList");
        const movieCountEl = document.getElementById("movieCount");

        // Count movies and folders separately
        const movieCount = movies.filter(
          (item) => item.type === "movie"
        ).length;
        const folderCount = movies.filter(
          (item) => item.type === "folder"
        ).length;

        // Update count display
        if (movies.length === 0) {
          movieCountEl.textContent = "No items";
        } else {
          const parts = [];
          if (movieCount > 0) {
            parts.push(
              `${movieCount} ${movieCount === 1 ? "movie" : "movies"}`
            );
          }
          if (folderCount > 0) {
            parts.push(
              `${folderCount} ${folderCount === 1 ? "folder" : "folders"}`
            );
          }
          movieCountEl.textContent = parts.join(", ");
        }

        if (movies.length === 0) {
          movieList.innerHTML =
            '<p style="text-align: center; color: rgba(255, 255, 255, 0.5);">No movies found</p>';
          return;
        }

        movieList.innerHTML = movies
          .map((item, index) => {
            const isFolder = item.type === "folder";
            const title = escapeHtml(item.title);
            const escapedTitle = title.replace(/'/g, "\\'");

            if (isFolder) {
              return `
                  <div class="movie-item" style="border-left: 4px solid #667eea;">
                      <img src="${
                        item.thumbnail
                      }" alt="${title}" onerror="this.src='/clapboard.jpg'">
                      <div class="movie-info">
                          <div class="movie-name">üìÅ ${title}</div>
                          <div style="color: rgba(255, 255, 255, 0.6); font-size: 0.85em; margin-top: 3px;">
                            ${item.itemCount} ${
                item.itemCount === 1 ? "item" : "items"
              }
                          </div>
                      </div>
                      <div class="movie-actions">
                          <button class="btn small-btn" onclick="openFolderMenu('${escapedTitle}', ${
                item.itemCount
              })">Manage</button>
                          <button class="btn small-btn btn-delete" onclick="deleteFolder('${escapedTitle}')">Delete</button>
                      </div>
                  </div>
                `;
            } else {
              return `
                  <div class="movie-item">
                      <img src="${item.thumbnail}" alt="${title}" onerror="this.src='/clapboard.jpg'">
                      <div class="movie-info">
                          <div class="movie-name">${title}</div>
                      </div>
                      <div class="movie-actions">
                          <button class="btn small-btn" onclick="openEditMenu('${escapedTitle}')">Edit</button>
                          <button class="btn small-btn" onclick="manageFolders('${escapedTitle}')">Folder</button>
                          <button class="btn small-btn btn-delete" onclick="deleteMovie('${escapedTitle}')">Delete</button>
                      </div>
                  </div>
                `;
            }
          })
          .join("");
      }

      function openEditMenu(movieTitle) {
        currentEditingMovie = movieTitle;
        const popup = document.getElementById("editMenuPopup");
        const overlay = document.getElementById("popupOverlay");
        const content = document.getElementById("editMenuContent");

        content.innerHTML = `
          <div class="popup-option" onclick="showRenameDialog('${movieTitle.replace(
            /'/g,
            "\\'"
          )}')">
            <div class="popup-option-title">‚úèÔ∏è Rename Movie</div>
            <div class="popup-option-desc">Change the name of this movie</div>
          </div>
          <div class="popup-option" onclick="document.getElementById('thumbnailUpload').click()">
            <div class="popup-option-title">üñºÔ∏è Upload Thumbnail</div>
            <div class="popup-option-desc">Upload a custom poster image</div>
          </div>
          <input type="file" id="thumbnailUpload" style="display: none;" accept="image/*" onchange="handleThumbnailUpload(this.files[0])">
        `;

        popup.classList.add("active");
        overlay.classList.add("active");
      }

      function closeEditMenu() {
        const popup = document.getElementById("editMenuPopup");
        const overlay = document.getElementById("popupOverlay");
        popup.classList.remove("active");
        overlay.classList.remove("active");
        currentEditingMovie = null;
      }

      function handleThumbnailUpload(file) {
        if (file && currentEditingMovie) {
          uploadThumbnail(currentEditingMovie, file);
          closeEditMenu();
        }
      }

      async function manageFolders(movieTitle) {
        currentEditingMovie = movieTitle;

        // Load available folders
        await loadFolders();

        const popup = document.getElementById("editMenuPopup");
        const overlay = document.getElementById("popupOverlay");
        const content = document.getElementById("editMenuContent");

        let folderOptions = availableFolders
          .map(
            (folder) =>
              `<option value="${escapeHtml(folder)}">${escapeHtml(
                folder
              )}</option>`
          )
          .join("");

        content.innerHTML = `
          <div style="margin-bottom: 20px;">
            <div style="font-weight: 600; margin-bottom: 10px; color: rgba(255, 255, 255, 0.9);">
              Move "${escapeHtml(movieTitle)}" to a folder
            </div>
            <div class="folder-select-container">
              <select id="folderSelect">
                <option value="">-- Select a folder --</option>
                ${folderOptions}
                <option value="__new__">+ Create New Folder</option>
              </select>
              <div id="newFolderInput" style="display: none;">
                <input type="text" id="newFolderName" placeholder="Enter new folder name" />
              </div>
              <button class="btn" style="width: 100%; margin-top: 10px;" onclick="moveToFolder()">Move to Folder</button>
            </div>
          </div>
        `;

        popup.classList.add("active");
        overlay.classList.add("active");

        // Add event listener for folder select
        document
          .getElementById("folderSelect")
          .addEventListener("change", function () {
            const newFolderInput = document.getElementById("newFolderInput");
            if (this.value === "__new__") {
              newFolderInput.style.display = "block";
            } else {
              newFolderInput.style.display = "none";
            }
          });
      }

      async function loadFolders() {
        try {
          const response = await fetch("/api/folders", {
            credentials: "include",
          });

          if (response.status === 401) {
            return;
          }

          availableFolders = await response.json();
        } catch (error) {
          console.error("Error loading folders:", error);
          availableFolders = [];
        }
      }

      async function moveToFolder() {
        const folderSelect = document.getElementById("folderSelect");
        const newFolderName = document.getElementById("newFolderName");

        let targetFolder = folderSelect.value;

        if (targetFolder === "__new__") {
          targetFolder = newFolderName.value.trim();
          if (!targetFolder) {
            alert("Please enter a folder name");
            return;
          }
        }

        if (!targetFolder) {
          alert("Please select a folder");
          return;
        }

        try {
          const response = await fetch("/api/move-to-folder", {
            method: "POST",
            credentials: "include",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              movieName: currentEditingMovie,
              folderName: targetFolder,
            }),
          });

          if (response.status === 401) {
            window.location.href =
              "/login?next=" + encodeURIComponent("/settings.html");
            return;
          }

          const result = await response.json();
          if (result.success) {
            showMessage(
              "generalMessage",
              "Movie moved to folder successfully!",
              "success"
            );
            closeEditMenu();
            loadMovies(); // Reload the list
          } else {
            showMessage("generalMessage", "Error: " + result.error, "error");
          }
        } catch (error) {
          showMessage(
            "generalMessage",
            "Error moving movie: " + error.message,
            "error"
          );
        }
      }

      async function deleteMovie(movieTitle) {
        if (
          !confirm(
            `Are you sure you want to delete "${movieTitle}"?\n\nThis will permanently delete the video file. This action cannot be undone.`
          )
        ) {
          return;
        }

        // Double confirmation for safety
        if (
          !confirm(`FINAL CONFIRMATION:\n\nDelete "${movieTitle}" permanently?`)
        ) {
          return;
        }

        try {
          const response = await fetch("/api/delete-movie", {
            method: "POST",
            credentials: "include",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ movieName: movieTitle }),
          });

          if (response.status === 401) {
            window.location.href =
              "/login?next=" + encodeURIComponent("/settings.html");
            return;
          }

          const result = await response.json();
          if (result.success) {
            showMessage(
              "generalMessage",
              "Movie deleted successfully!",
              "success"
            );
            loadMovies(); // Reload the list
          } else {
            showMessage("generalMessage", "Error: " + result.error, "error");
          }
        } catch (error) {
          showMessage(
            "generalMessage",
            "Error deleting movie: " + error.message,
            "error"
          );
        }
      }

      async function openFolderMenu(folderTitle, itemCount) {
        currentEditingMovie = folderTitle; // Reuse for folder name
        const popup = document.getElementById("editMenuPopup");
        const overlay = document.getElementById("popupOverlay");
        const content = document.getElementById("editMenuContent");

        // Load folder contents
        let folderContents = [];
        try {
          const response = await fetch(
            `/api/folder-contents/${encodeURIComponent(folderTitle)}`,
            {
              credentials: "include",
            }
          );
          if (response.ok) {
            folderContents = await response.json();
          }
        } catch (error) {
          console.error("Error loading folder contents:", error);
        }

        let contentsHTML = "";
        if (folderContents.length > 0) {
          contentsHTML = `
            <div style="margin-bottom: 20px; max-height: 200px; overflow-y: auto; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px;">
              <div style="font-weight: 600; margin-bottom: 10px; color: rgba(255, 255, 255, 0.7);">
                Contents (${folderContents.length} ${
            folderContents.length === 1 ? "item" : "items"
          }):
              </div>
              ${folderContents
                .map(
                  (movie) => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: rgba(255,255,255,0.05); margin-bottom: 5px; border-radius: 5px;">
                  <span style="font-size: 0.9em;">${escapeHtml(
                    movie.title
                  )}</span>
                  <button class="btn small-btn" style="padding: 5px 10px; font-size: 0.8em;" onclick="showEpisodeMenu('${folderTitle.replace(
                    /'/g,
                    "\\'"
                  )}', '${escapeHtml(movie.title).replace(
                    /'/g,
                    "\\'"
                  )}')">‚ãÆ</button>
                </div>
              `
                )
                .join("")}
            </div>
          `;
        }

        content.innerHTML = `
          <div class="popup-option" onclick="renameFolder('${folderTitle.replace(
            /'/g,
            "\\'"
          )}')">
            <div class="popup-option-title">‚úèÔ∏è Rename Folder</div>
            <div class="popup-option-desc">Change the name of this folder</div>
          </div>
          <div class="popup-option" onclick="document.getElementById('folderThumbnailUpload').click()">
            <div class="popup-option-title">üñºÔ∏è Upload Folder Thumbnail</div>
            <div class="popup-option-desc">Upload a custom poster image for this folder</div>
          </div>
          ${contentsHTML}
          <input type="file" id="folderThumbnailUpload" style="display: none;" accept="image/*" onchange="handleFolderThumbnailUpload(this.files[0])">
        `;

        popup.classList.add("active");
        overlay.classList.add("active");
      }

      function handleFolderThumbnailUpload(file) {
        if (file && currentEditingMovie) {
          uploadThumbnail(currentEditingMovie, file);
          closeEditMenu();
        }
      }

      async function renameFolder(oldName) {
        const newName = prompt("Enter new name for the folder:", oldName);
        if (!newName || newName === oldName) return;

        try {
          const response = await fetch("/api/rename-folder", {
            method: "POST",
            credentials: "include",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ oldName, newName }),
          });

          if (response.status === 401) {
            window.location.href =
              "/login?next=" + encodeURIComponent("/settings.html");
            return;
          }

          const result = await response.json();
          if (result.success) {
            showMessage(
              "generalMessage",
              "Folder renamed successfully!",
              "success"
            );
            closeEditMenu();
            loadMovies(); // Reload the list
          } else {
            showMessage("generalMessage", "Error: " + result.error, "error");
          }
        } catch (error) {
          showMessage(
            "generalMessage",
            "Error renaming folder: " + error.message,
            "error"
          );
        }
      }

      async function deleteFolder(folderTitle) {
        if (
          !confirm(
            `Are you sure you want to delete the folder "${folderTitle}"?\n\nThis will permanently delete the folder and ALL videos inside it. This action cannot be undone.`
          )
        ) {
          return;
        }

        // Double confirmation for safety
        if (
          !confirm(
            `FINAL CONFIRMATION:\n\nDelete "${folderTitle}" and ALL its contents permanently?`
          )
        ) {
          return;
        }

        try {
          const response = await fetch("/api/delete-folder", {
            method: "POST",
            credentials: "include",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ folderName: folderTitle }),
          });

          if (response.status === 401) {
            window.location.href =
              "/login?next=" + encodeURIComponent("/settings.html");
            return;
          }

          const result = await response.json();
          if (result.success) {
            showMessage(
              "generalMessage",
              "Folder deleted successfully!",
              "success"
            );
            loadMovies(); // Reload the list
          } else {
            showMessage("generalMessage", "Error: " + result.error, "error");
          }
        } catch (error) {
          showMessage(
            "generalMessage",
            "Error deleting folder: " + error.message,
            "error"
          );
        }
      }

      function showEpisodeMenu(folderName, movieName) {
        const popup = document.getElementById("editMenuPopup");
        const overlay = document.getElementById("popupOverlay");
        const content = document.getElementById("editMenuContent");

        content.innerHTML = `
          <div class="popup-option" onclick="moveFromFolder('${folderName.replace(
            /'/g,
            "\\'"
          )}', '${movieName.replace(/'/g, "\\'")}')">
            <div class="popup-option-title">üì§ Move Out</div>
            <div class="popup-option-desc">Move this episode out of the folder to the main library</div>
          </div>
          <div class="popup-option" onclick="showRenameEpisodeDialog('${folderName.replace(
            /'/g,
            "\\'"
          )}', '${movieName.replace(/'/g, "\\'")}')">
            <div class="popup-option-title">‚úèÔ∏è Rename Episode</div>
            <div class="popup-option-desc">Change the name of this episode</div>
          </div>
          <div class="popup-option" onclick="deleteEpisode('${folderName.replace(
            /'/g,
            "\\'"
          )}', '${movieName.replace(/'/g, "\\'")}')">
            <div class="popup-option-title">üóëÔ∏è Delete Episode</div>
            <div class="popup-option-desc">Permanently delete this episode</div>
          </div>
          <div class="popup-option" onclick="showSplitEpisodeDialog('${folderName.replace(
            /'/g,
            "\\'"
          )}', '${movieName.replace(/'/g, "\\'")}')">
            <div class="popup-option-title">‚úÇÔ∏è Split into 2 Episodes</div>
            <div class="popup-option-desc">Split this episode at a specific timestamp</div>
          </div>
        `;

        popup.classList.add("active");
        overlay.classList.add("active");
      }

      async function moveFromFolder(folderName, movieName) {
        if (
          !confirm(
            `Move "${movieName}" out of "${folderName}" to the main library?`
          )
        ) {
          return;
        }

        try {
          const response = await fetch("/api/move-from-folder", {
            method: "POST",
            credentials: "include",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ folderName, movieName }),
          });

          if (response.status === 401) {
            window.location.href =
              "/login?next=" + encodeURIComponent("/settings.html");
            return;
          }

          const result = await response.json();
          if (result.success) {
            showMessage(
              "generalMessage",
              "Movie moved out of folder successfully!",
              "success"
            );
            closeEditMenu();
            loadMovies(); // Reload the list
          } else {
            showMessage("generalMessage", "Error: " + result.error, "error");
          }
        } catch (error) {
          showMessage(
            "generalMessage",
            "Error moving movie: " + error.message,
            "error"
          );
        }
      }

      function showRenameEpisodeDialog(folderName, oldName) {
        const popup = document.getElementById("editMenuPopup");
        const content = document.getElementById("editMenuContent");

        content.innerHTML = `
          <div style="margin-bottom: 20px;">
            <div style="font-weight: 600; margin-bottom: 10px; color: rgba(255, 255, 255, 0.9);">
              Rename Episode
            </div>
            <div class="form-group" style="margin-bottom: 15px;">
              <label for="newEpisodeName">New Name</label>
              <input type="text" id="newEpisodeName" value="${escapeHtml(
                oldName
              )}" style="width: 100%; padding: 12px; background: rgba(255, 255, 255, 0.1); border: 2px solid rgba(255, 255, 255, 0.2); border-radius: 8px; color: white; font-size: 1em;">
            </div>
            <div style="display: flex; gap: 10px;">
              <button class="btn" style="flex: 1;" onclick="submitRenameEpisode('${folderName.replace(
                /'/g,
                "\\'"
              )}', '${oldName.replace(/'/g, "\\'")}')">Save</button>
              <button class="btn btn-secondary" style="flex: 1;" onclick="closeEditMenu()">Cancel</button>
            </div>
          </div>
        `;
      }

      async function submitRenameEpisode(folderName, oldName) {
        const newName = document.getElementById("newEpisodeName").value.trim();

        if (!newName) {
          showMessage(
            "generalMessage",
            "Episode name cannot be empty",
            "error"
          );
          return;
        }

        if (newName === oldName) {
          closeEditMenu();
          return;
        }

        try {
          const response = await fetch("/api/rename-episode", {
            method: "POST",
            credentials: "include",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ folderName, oldName, newName }),
          });

          if (response.status === 401) {
            window.location.href =
              "/login?next=" + encodeURIComponent("/settings.html");
            return;
          }

          const result = await response.json();
          if (result.success) {
            showMessage(
              "generalMessage",
              "Episode renamed successfully!",
              "success"
            );
            closeEditMenu();
            loadMovies();
          } else {
            showMessage("generalMessage", "Error: " + result.error, "error");
          }
        } catch (error) {
          showMessage("generalMessage", "Error: " + error.message, "error");
        }
      }

      async function deleteEpisode(folderName, movieName) {
        if (
          !confirm(
            `Are you sure you want to permanently delete "${movieName}"?`
          )
        ) {
          return;
        }

        try {
          const response = await fetch("/api/delete-episode", {
            method: "POST",
            credentials: "include",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ folderName, movieName }),
          });

          if (response.status === 401) {
            window.location.href =
              "/login?next=" + encodeURIComponent("/settings.html");
            return;
          }

          const result = await response.json();
          if (result.success) {
            showMessage(
              "generalMessage",
              "Episode deleted successfully!",
              "success"
            );
            closeEditMenu();
            loadMovies();
          } else {
            showMessage("generalMessage", "Error: " + result.error, "error");
          }
        } catch (error) {
          showMessage("generalMessage", "Error: " + error.message, "error");
        }
      }

      function showSplitEpisodeDialog(folderName, movieName) {
        const popup = document.getElementById("editMenuPopup");
        const content = document.getElementById("editMenuContent");

        content.innerHTML = `
          <div style="margin-bottom: 20px;">
            <div style="font-weight: 600; margin-bottom: 10px; color: rgba(255, 255, 255, 0.9);">
              Split Episode into 2 Parts
            </div>
            <div style="margin-bottom: 15px; color: rgba(255, 255, 255, 0.7); font-size: 0.9em;">
              Episode: ${escapeHtml(movieName)}
            </div>
            <div class="form-group" style="margin-bottom: 15px;">
              <label for="splitTimestamp">Split at timestamp (HH:MM:SS or MM:SS)</label>
              <input type="text" id="splitTimestamp" placeholder="00:45:30" style="width: 100%; padding: 12px; background: rgba(255, 255, 255, 0.1); border: 2px solid rgba(255, 255, 255, 0.2); border-radius: 8px; color: white; font-size: 1em;">
              <small style="color: rgba(255, 255, 255, 0.6); display: block; margin-top: 5px;">
                Examples: "45:30" (45 min 30 sec), "01:15:00" (1 hour 15 min)
              </small>
            </div>
            <div style="display: flex; gap: 10px;">
              <button class="btn" style="flex: 1;" onclick="submitSplitEpisode('${folderName.replace(
                /'/g,
                "\\'"
              )}', '${movieName.replace(/'/g, "\\'")}')">Split Episode</button>
              <button class="btn btn-secondary" style="flex: 1;" onclick="closeEditMenu()">Cancel</button>
            </div>
          </div>
        `;
      }

      function parseTimestamp(timestamp) {
        // Remove whitespace
        timestamp = timestamp.trim();

        // Match HH:MM:SS or MM:SS format
        const match = timestamp.match(/^(?:(\d{1,2}):)?(\d{1,2}):(\d{1,2})$/);

        if (!match) {
          return null;
        }

        const hours = match[1] ? parseInt(match[1]) : 0;
        const minutes = parseInt(match[2]);
        const seconds = parseInt(match[3]);

        // Validate ranges
        if (minutes >= 60 || seconds >= 60) {
          return null;
        }

        // Return in HH:MM:SS format
        return `${String(hours).padStart(2, "0")}:${String(minutes).padStart(
          2,
          "0"
        )}:${String(seconds).padStart(2, "0")}`;
      }

      async function submitSplitEpisode(folderName, movieName) {
        const timestampInput = document
          .getElementById("splitTimestamp")
          .value.trim();

        if (!timestampInput) {
          showMessage("generalMessage", "Please enter a timestamp", "error");
          return;
        }

        const timestamp = parseTimestamp(timestampInput);
        if (!timestamp) {
          showMessage(
            "generalMessage",
            "Invalid timestamp format. Use HH:MM:SS or MM:SS",
            "error"
          );
          return;
        }

        if (timestamp === "00:00:00") {
          showMessage(
            "generalMessage",
            "Timestamp must be greater than 00:00:00",
            "error"
          );
          return;
        }

        // Show confirmation
        if (
          !confirm(
            `Split "${movieName}" at ${timestamp}?\n\nThis will create two new episodes and delete the original.`
          )
        ) {
          return;
        }

        try {
          showMessage(
            "generalMessage",
            "Splitting episode... This may take a few minutes.",
            "success"
          );

          const response = await fetch("/api/split-episode", {
            method: "POST",
            credentials: "include",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ folderName, movieName, timestamp }),
          });

          if (response.status === 401) {
            window.location.href =
              "/login?next=" + encodeURIComponent("/settings.html");
            return;
          }

          const result = await response.json();
          if (result.success) {
            showMessage(
              "generalMessage",
              "Episode split successfully!",
              "success"
            );
            closeEditMenu();
            loadMovies();
          } else {
            showMessage("generalMessage", "Error: " + result.error, "error");
          }
        } catch (error) {
          showMessage("generalMessage", "Error: " + error.message, "error");
        }
      }

      function showRenameDialog(oldName) {
        const popup = document.getElementById("editMenuPopup");
        const content = document.getElementById("editMenuContent");

        content.innerHTML = `
          <div style="margin-bottom: 20px;">
            <div style="font-weight: 600; margin-bottom: 10px; color: rgba(255, 255, 255, 0.9);">
              Rename Movie
            </div>
            <div class="form-group" style="margin-bottom: 15px;">
              <label for="newMovieName">New Name</label>
              <input type="text" id="newMovieName" value="${escapeHtml(
                oldName
              )}" style="width: 100%; padding: 12px; background: rgba(255, 255, 255, 0.1); border: 2px solid rgba(255, 255, 255, 0.2); border-radius: 8px; color: white; font-size: 1em;">
            </div>
            <div class="form-group" style="margin-bottom: 15px;">
              <label class="checkbox-label">
                <input type="checkbox" id="searchNewThumbnail">
                <span>Search for new thumbnail</span>
              </label>
              <small style="color: rgba(255, 255, 255, 0.6); display: block; margin-top: 5px; margin-left: 30px;">
                If checked, the old thumbnail will be deleted and a new one will be searched based on the movie name (you can check this without renaming)
              </small>
            </div>
            <div style="display: flex; gap: 10px;">
              <button class="btn" style="flex: 1;" onclick="submitRename('${oldName.replace(
                /'/g,
                "\\'"
              )}')">Save</button>
              <button class="btn btn-secondary" style="flex: 1;" onclick="closeEditMenu()">Cancel</button>
            </div>
          </div>
        `;
      }

      async function submitRename(oldName) {
        const newName = document.getElementById("newMovieName").value.trim();
        const searchNewThumbnail =
          document.getElementById("searchNewThumbnail").checked;

        if (!newName) {
          showMessage("generalMessage", "Movie name cannot be empty", "error");
          return;
        }

        // Check if anything changed
        const nameChanged = newName !== oldName;

        if (!nameChanged && !searchNewThumbnail) {
          // Nothing to do
          closeEditMenu();
          return;
        }

        try {
          const response = await fetch("/api/rename-movie", {
            method: "POST",
            credentials: "include",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ oldName, newName, searchNewThumbnail }),
          });

          if (response.status === 401) {
            window.location.href =
              "/login?next=" + encodeURIComponent("/settings.html");
            return;
          }

          const result = await response.json();
          if (result.success) {
            let message = "";
            if (nameChanged && searchNewThumbnail) {
              message =
                "Movie renamed successfully! Searching for new thumbnail...";
            } else if (nameChanged) {
              message = "Movie renamed successfully!";
            } else if (searchNewThumbnail) {
              message = "Searching for new thumbnail...";
            }

            showMessage("generalMessage", message, "success");
            closeEditMenu();
            loadMovies(); // Reload the list
          } else {
            showMessage("generalMessage", "Error: " + result.error, "error");
          }
        } catch (error) {
          showMessage("generalMessage", "Error: " + error.message, "error");
        }
      }

      async function uploadThumbnail(movieName, file) {
        if (!file) return;

        const formData = new FormData();
        formData.append("movieName", movieName);
        formData.append("thumbnail", file);

        try {
          const response = await fetch("/api/upload-thumbnail", {
            method: "POST",
            credentials: "include",
            body: formData,
          });

          if (response.status === 401) {
            window.location.href =
              "/login?next=" + encodeURIComponent("/settings.html");
            return;
          }

          const result = await response.json();
          if (result.success) {
            showMessage(
              "generalMessage",
              "Thumbnail uploaded successfully!",
              "success"
            );
            loadMovies(); // Reload to show new thumbnail
          } else {
            showMessage("generalMessage", "Error: " + result.error, "error");
          }
        } catch (error) {
          showMessage(
            "generalMessage",
            "Error uploading thumbnail: " + error.message,
            "error"
          );
        }
      }

      async function detectIPAddress() {
        try {
          const response = await fetch("/api/detect-ip");
          const data = await response.json();

          if (data.url) {
            document.getElementById("url").value = data.url;
            showMessage(
              "generalMessage",
              "IP address detected: " + data.url,
              "success"
            );
          } else {
            showMessage(
              "generalMessage",
              "Could not detect IP address",
              "error"
            );
          }
        } catch (error) {
          showMessage(
            "generalMessage",
            "Error detecting IP: " + error.message,
            "error"
          );
        }
      }

      async function loadGeneralSettings() {
        try {
          const response = await fetch("/api/settings", {
            credentials: "include",
          });
          if (response.status === 401) {
            // window.location.href = '/login?next=' + encodeURIComponent('/settings.html');
            return;
          }
          const settings = await response.json();
          document.getElementById("serviceName").value =
            settings.serviceName || "";
          document.getElementById("url").value = settings.url || "";
          document.getElementById("password").value = settings.password || "";
          document.getElementById("passwordRequired").checked =
            settings.passwordRequired || false;
        } catch (error) {
          console.error("Error loading settings:", error);
        }
      }

      async function saveGeneralSettings() {
        const settings = {
          serviceName: document.getElementById("serviceName").value,
          url: document.getElementById("url").value,
          password: document.getElementById("password").value,
          passwordRequired: document.getElementById("passwordRequired").checked,
        };

        try {
          const response = await fetch("/api/settings", {
            method: "POST",
            credentials: "include",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(settings),
          });

          if (response.status === 401) {
            // window.location.href = '/login?next=' + encodeURIComponent('/settings.html');
            return;
          }

          const result = await response.json();
          if (result.success) {
            showMessage(
              "generalMessage",
              "Settings saved successfully!",
              "success"
            );
          } else {
            showMessage("generalMessage", "Error: " + result.error, "error");
          }
        } catch (error) {
          showMessage(
            "generalMessage",
            "Error saving settings: " + error.message,
            "error"
          );
        }
      }

      async function updateSoftware() {
        if (
          !confirm(
            "This will update the software by running 'git pull' and restarting the service. The service will be unavailable for a few seconds. Continue?"
          )
        ) {
          return;
        }

        showMessage(
          "updateMessage",
          "Updating software... The service will restart shortly.",
          "success"
        );

        try {
          const response = await fetch("/api/update-software", {
            method: "POST",
            credentials: "include",
          });

          if (response.status === 401) {
            return;
          }

          const result = await response.json();
          if (result.success) {
            showMessage(
              "updateMessage",
              "Update initiated! The service is restarting. This page will reload in 5 seconds...",
              "success"
            );
            // Reload the page after 5 seconds to reconnect after restart
            setTimeout(() => {
              window.location.reload();
            }, 5000);
          } else {
            showMessage("updateMessage", "Error: " + result.error, "error");
          }
        } catch (error) {
          showMessage(
            "updateMessage",
            "Update may have started (connection lost during restart). Reloading in 5 seconds...",
            "success"
          );
          setTimeout(() => {
            window.location.reload();
          }, 5000);
        }
      }

      async function loadVersion() {
        try {
          const response = await fetch("/version");
          const versionData = await response.json();
          const versionElement = document.getElementById("versionInfo");

          if (versionData.version) {
            versionElement.textContent = `Version: ${versionData.version}`;
          } else {
            versionElement.textContent = "Version: Unknown";
          }
        } catch (error) {
          console.error("Error loading version:", error);
          document.getElementById("versionInfo").textContent =
            "Version: Error loading";
        }
      }

      async function loadRipperSettings() {
        try {
          const response = await fetch("/api/ripper-settings", {
            credentials: "include",
          });
          if (response.status === 401) {
            return;
          }
          const settings = await response.json();
          document.getElementById("outputSubfolder").value =
            settings.outputSubfolder || "";
          document.getElementById("titlesToRip").value =
            settings.titlesToRip || 1;
          document.getElementById("minTitleLength").value =
            settings.minTitleLength || 300;
          document.getElementById("autoDetectEpisodes").checked =
            settings.autoDetectEpisodes || false;
          document.getElementById("autoEject").checked =
            settings.autoEject !== undefined ? settings.autoEject : true;
          document.getElementById("notifyOnComplete").checked =
            settings.notifyOnComplete !== undefined
              ? settings.notifyOnComplete
              : true;
          document.getElementById("keepMKV").checked =
            settings.keepMKV || false;
        } catch (error) {
          console.error("Error loading ripper settings:", error);
        }
      }

      async function saveRipperSettings() {
        const settings = {
          outputSubfolder: document
            .getElementById("outputSubfolder")
            .value.trim(),
          titlesToRip: parseInt(document.getElementById("titlesToRip").value),
          minTitleLength: parseInt(
            document.getElementById("minTitleLength").value
          ),
          autoDetectEpisodes:
            document.getElementById("autoDetectEpisodes").checked,
          autoEject: document.getElementById("autoEject").checked,
          notifyOnComplete: document.getElementById("notifyOnComplete").checked,
          keepMKV: document.getElementById("keepMKV").checked,
        };

        try {
          const response = await fetch("/api/ripper-settings", {
            method: "POST",
            credentials: "include",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(settings),
          });

          if (response.status === 401) {
            return;
          }

          const result = await response.json();
          if (result.success) {
            showMessage(
              "ripperMessage",
              "Ripper settings saved successfully!",
              "success"
            );
          } else {
            showMessage("ripperMessage", "Error: " + result.error, "error");
          }
        } catch (error) {
          showMessage(
            "ripperMessage",
            "Error saving ripper settings: " + error.message,
            "error"
          );
        }
      }

      async function loadNotifications() {
        try {
          const response = await fetch("/api/notifications", {
            credentials: "include",
          });

          if (response.status === 401) {
            console.log("Not authenticated for notifications");
            return;
          }

          const notifications = await response.json();
          renderNotifications(notifications);
        } catch (error) {
          console.error("Error loading notifications:", error);
          const container = document.getElementById("notificationsList");
          container.innerHTML =
            '<p style="text-align: center; color: rgba(255,100,100,0.7); padding: 20px;">Error loading notifications. Please try refreshing.</p>';
        }
      }

      function renderNotifications(notifications) {
        const container = document.getElementById("notificationsList");

        if (!notifications || notifications.length === 0) {
          container.innerHTML =
            '<p style="text-align: center; color: rgba(255,255,255,0.5); padding: 20px;">No notifications yet</p>';
          return;
        }

        container.innerHTML = notifications
          .map((notif) => {
            const icons = {
              success: "‚úì",
              info: "‚Ñπ",
              warning: "‚ö†",
              error: "‚úó",
            };

            const date = new Date(notif.timestamp);
            const timeStr = date.toLocaleTimeString("en-US", {
              hour: "2-digit",
              minute: "2-digit",
            });
            const dateStr = date.toLocaleDateString("en-US", {
              month: "short",
              day: "numeric",
            });

            return `
                    <div class="notification-item ${notif.type}">
                        <div class="notification-icon">${
                          icons[notif.type] || "‚Ñπ"
                        }</div>
                        <div class="notification-content">
                            <div class="notification-title">${notif.title}</div>
                            <div class="notification-message">${
                              notif.message
                            }</div>
                        </div>
                        <div class="notification-time">${timeStr}<br><span style="font-size: 10px; opacity: 0.7;">${dateStr}</span></div>
                    </div>
                `;
          })
          .reverse()
          .join("");
      }

      async function clearNotifications() {
        if (
          !confirm("Are you sure you want to clear all notification history?")
        ) {
          return;
        }

        try {
          await fetch("/api/notifications/clear", {
            method: "POST",
            credentials: "include",
          });
          loadNotifications();
        } catch (error) {
          alert("Error clearing notifications: " + error.message);
        }
      }

      function showMessage(elementId, message, type) {
        const messageEl = document.getElementById(elementId);
        messageEl.textContent = message;
        messageEl.className = "message " + type;
        messageEl.style.display = "block";
        setTimeout(() => {
          messageEl.style.display = "none";
        }, 5000);
      }

      // Auto-refresh notifications when on notifications tab
      let notificationRefreshInterval;
      function startNotificationRefresh() {
        loadNotifications();
        notificationRefreshInterval = setInterval(loadNotifications, 5000);
      }

      function stopNotificationRefresh() {
        if (notificationRefreshInterval) {
          clearInterval(notificationRefreshInterval);
        }
      }

      // Initialize
      loadMovies();
      loadGeneralSettings();
      loadRipperSettings();
      loadVersion();
    </script>
  </body>
</html>
